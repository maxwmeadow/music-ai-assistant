<!DOCTYPE html>
<html>
<head>
    <title>Advanced Music Runner Test Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            font-family: monospace;
        }

        h2 {
            color: #4CAF50;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Advanced Music Runner Test Player</h1>
    <p>Testing full song generation with multiple tracks: drums, bass, lead synth, and pad</p>

    <div class="container">
        <div class="panel">
            <h2>Controls</h2>
            <button onclick="testFullSong()">üéµ Play Full Song</button>
            <button onclick="testMelodyOnly()">üé§ Play Melody Only</button>
            <button onclick="testDrumsOnly()">ü•Å Play Drums Only</button>
            <button onclick="stopMusic()">‚èπ Stop</button>

            <div class="status" id="status">Ready to play music...</div>
        </div>

        <div class="panel">
            <h2>Current Song Structure</h2>
            <div id="songInfo">
                <strong>Tempo:</strong> 128 BPM<br>
                <strong>Key:</strong> Am<br>
                <strong>Duration:</strong> 16 bars<br>
                <strong>Tracks:</strong>
                <ul>
                    <li>Drums (kick, snare, hi-hat pattern)</li>
                    <li>Bass (root notes and fifths)</li>
                    <li>Lead (melodic line)</li>
                    <li>Pad (sustained chords)</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>Generated DSL Code</h2>
        <pre id="dslOutput">Click a play button to see generated code...</pre>
    </div>

    <script>
        let isPlaying = false;

        // Full song with multiple tracks
        const fullSongData = {
            musicData: {
                metadata: {
                    tempo: 128,
                    key: "Am",
                    time_signature: "4/4",
                    duration: 16
                },
                tracks: [
                    {
                        id: "drums",
                        type: "percussive",
                        source: "beatbox2drums",
                        samples: [
                            // Kick pattern (every beat)
                            {sample: "kick", start: 0.0, velocity: 1.0},
                            {sample: "kick", start: 2.0, velocity: 0.9},
                            {sample: "kick", start: 4.0, velocity: 1.0},
                            {sample: "kick", start: 6.0, velocity: 0.9},
                            {sample: "kick", start: 8.0, velocity: 1.0},
                            {sample: "kick", start: 10.0, velocity: 0.9},
                            {sample: "kick", start: 12.0, velocity: 1.0},
                            {sample: "kick", start: 14.0, velocity: 0.9},

                            // Snare pattern (offbeats)
                            {sample: "snare", start: 1.0, velocity: 0.8},
                            {sample: "snare", start: 3.0, velocity: 0.7},
                            {sample: "snare", start: 5.0, velocity: 0.8},
                            {sample: "snare", start: 7.0, velocity: 0.7},
                            {sample: "snare", start: 9.0, velocity: 0.8},
                            {sample: "snare", start: 11.0, velocity: 0.7},
                            {sample: "snare", start: 13.0, velocity: 0.8},
                            {sample: "snare", start: 15.0, velocity: 0.7}
                        ]
                    },
                    {
                        id: "bass",
                        type: "melodic",
                        source: "arranger",
                        instrument: "bass_synth",
                        notes: [
                            // Am - F - C - G progression (root notes)
                            {pitch: 45, start: 0.0, duration: 2.0, velocity: 0.9},   // A2
                            {pitch: 41, start: 2.0, duration: 2.0, velocity: 0.9},   // F2
                            {pitch: 36, start: 4.0, duration: 2.0, velocity: 0.9},   // C2
                            {pitch: 43, start: 6.0, duration: 2.0, velocity: 0.9},   // G2

                            {pitch: 45, start: 8.0, duration: 2.0, velocity: 0.9},   // A2
                            {pitch: 41, start: 10.0, duration: 2.0, velocity: 0.9},  // F2
                            {pitch: 36, start: 12.0, duration: 2.0, velocity: 0.9},  // C2
                            {pitch: 43, start: 14.0, duration: 2.0, velocity: 0.9}   // G2
                        ]
                    },
                    {
                        id: "lead",
                        type: "melodic",
                        source: "hum2melody",
                        instrument: "lead_synth",
                        notes: [
                            // Melodic phrase in Am
                            {pitch: 69, start: 0.0, duration: 0.5, velocity: 0.8},   // A4
                            {pitch: 72, start: 0.5, duration: 0.5, velocity: 0.7},   // C5
                            {pitch: 76, start: 1.0, duration: 1.0, velocity: 0.9},   // E5
                            {pitch: 74, start: 2.0, duration: 0.5, velocity: 0.8},   // D5
                            {pitch: 72, start: 2.5, duration: 0.5, velocity: 0.7},   // C5
                            {pitch: 69, start: 3.0, duration: 1.0, velocity: 0.8},   // A4

                            // Second phrase
                            {pitch: 65, start: 4.0, duration: 0.5, velocity: 0.8},   // F4
                            {pitch: 67, start: 4.5, duration: 0.5, velocity: 0.7},   // G4
                            {pitch: 69, start: 5.0, duration: 1.0, velocity: 0.9},   // A4
                            {pitch: 72, start: 6.0, duration: 0.5, velocity: 0.8},   // C5
                            {pitch: 76, start: 6.5, duration: 0.5, velocity: 0.7},   // E5
                            {pitch: 79, start: 7.0, duration: 1.0, velocity: 0.9},   // G5

                            // Repeat with variation
                            {pitch: 81, start: 8.0, duration: 0.5, velocity: 0.8},   // A5
                            {pitch: 79, start: 8.5, duration: 0.5, velocity: 0.7},   // G5
                            {pitch: 76, start: 9.0, duration: 1.0, velocity: 0.9},   // E5
                            {pitch: 74, start: 10.0, duration: 0.5, velocity: 0.8},  // D5
                            {pitch: 72, start: 10.5, duration: 0.5, velocity: 0.7},  // C5
                            {pitch: 69, start: 11.0, duration: 1.0, velocity: 0.8},  // A4

                            // Final phrase
                            {pitch: 65, start: 12.0, duration: 1.0, velocity: 0.8},  // F4
                            {pitch: 67, start: 13.0, duration: 1.0, velocity: 0.7},  // G4
                            {pitch: 69, start: 14.0, duration: 2.0, velocity: 0.9}   // A4 (hold)
                        ]
                    },
                    {
                        id: "pad",
                        type: "harmonic",
                        source: "arranger",
                        instrument: "pad_synth",
                        notes: [
                            // Am chord (A-C-E)
                            {pitch: 57, start: 0.0, duration: 4.0, velocity: 0.4},   // A3
                            {pitch: 60, start: 0.0, duration: 4.0, velocity: 0.4},   // C4
                            {pitch: 64, start: 0.0, duration: 4.0, velocity: 0.4},   // E4

                            // F chord (F-A-C)
                            {pitch: 53, start: 4.0, duration: 4.0, velocity: 0.4},   // F3
                            {pitch: 57, start: 4.0, duration: 4.0, velocity: 0.4},   // A3
                            {pitch: 60, start: 4.0, duration: 4.0, velocity: 0.4},   // C4

                            // C chord (C-E-G)
                            {pitch: 48, start: 8.0, duration: 4.0, velocity: 0.4},   // C3
                            {pitch: 52, start: 8.0, duration: 4.0, velocity: 0.4},   // E3
                            {pitch: 55, start: 8.0, duration: 4.0, velocity: 0.4},   // G3

                            // G chord (G-B-D)
                            {pitch: 55, start: 12.0, duration: 4.0, velocity: 0.4},  // G3
                            {pitch: 59, start: 12.0, duration: 4.0, velocity: 0.4},  // B3
                            {pitch: 62, start: 12.0, duration: 4.0, velocity: 0.4}   // D4
                        ]
                    }
                ]
            }
        };

        // Melody only data
        const melodyOnlyData = {
            musicData: {
                metadata: { tempo: 128, key: "Am", time_signature: "4/4", duration: 8 },
                tracks: [fullSongData.musicData.tracks[2]] // Just the lead track
            }
        };

        // Drums only data
        const drumsOnlyData = {
            musicData: {
                metadata: { tempo: 128, key: "Am", time_signature: "4/4", duration: 8 },
                tracks: [fullSongData.musicData.tracks[0]] // Just the drums track
            }
        };

        async function playMusic(testData, description) {
            if (isPlaying) {
                updateStatus("Music already playing. Stop first.");
                return;
            }

            updateStatus(`Loading ${description}...`);

            try {
                const response = await fetch('http://localhost:5001/eval', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                // Display the DSL code
                document.getElementById('dslOutput').textContent = result.dsl_code;

                updateStatus(`Playing ${description}...`);
                isPlaying = true;

                // Execute the generated Tone.js code
                eval(result.executable_code);

                // Auto-reset playing state after music finishes
                setTimeout(() => {
                    isPlaying = false;
                    updateStatus("Music finished. Ready to play again.");
                }, 17000); // Slightly longer than the 16-second song

            } catch (error) {
                console.error('Error:', error);
                updateStatus(`Error: ${error.message}`);
                isPlaying = false;
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(`[Status] ${message}`);
        }

        function testFullSong() {
            playMusic(fullSongData, "full song with drums, bass, lead, and pad");
        }

        function testMelodyOnly() {
            playMusic(melodyOnlyData, "melody only");
        }

        function testDrumsOnly() {
            playMusic(drumsOnlyData, "drums only");
        }

        function stopMusic() {
            if (typeof Tone !== 'undefined') {
                Tone.Transport.stop();
                Tone.Transport.cancel();
            }
            isPlaying = false;
            updateStatus("Music stopped. Ready to play again.");
        }

        // Initialize
        updateStatus("Ready to play music. Make sure your runner server is running on localhost:5001");
    </script>
</body>
</html>