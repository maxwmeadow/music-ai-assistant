<!DOCTYPE html>
<html>
<head>
    <title>Tone.js Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>
    <h1>Music Test</h1>
    <button id="playBtn">Play Music</button>

    <script>
        document.getElementById('playBtn').addEventListener('click', async () => {
            // Paste your generated executable_code here

            // Auto-generated Tone.js from DSL

            // ===== InstrumentRegistry Class =====
            class InstrumentRegistry {
                constructor() {
                    this.instruments = new Map();
                    this.initializeInstruments();
                }

                initializeInstruments() {
                    // Synth instruments
                    this.registerSynth('synth_lead', () => {
                        return new Tone.MonoSynth({
                            oscillator: { type: 'sawtooth' },
                            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 },
                            filterEnvelope: { attack: 0.06, decay: 0.2, sustain: 0.5, release: 2, baseFrequency: 200, octaves: 7 }
                        }).toDestination();
                    });

                    this.registerSynth('pad', () => {
                        return new Tone.PolySynth(Tone.Synth, {
                            oscillator: { type: 'sine' },
                            envelope: { attack: 0.5, decay: 0.3, sustain: 0.7, release: 2 }
                        }).toDestination();
                    });

                    this.registerSynth('bass', () => {
                        return new Tone.MonoSynth({
                            oscillator: { type: 'square' },
                            envelope: { attack: 0.01, decay: 0.2, sustain: 0.4, release: 0.3 },
                            filter: { type: 'lowpass', frequency: 800 }
                        }).toDestination();
                    });

                    this.registerSynth('bells', () => {
                        return new Tone.MetalSynth({
                            frequency: 200,
                            envelope: { attack: 0.001, decay: 1.4, release: 0.2 },
                            harmonicity: 5.1,
                            modulationIndex: 32,
                            resonance: 4000
                        }).toDestination();
                    });

                    this.registerSynth('strings', () => {
                        return new Tone.PolySynth(Tone.Synth, {
                            oscillator: { type: 'sawtooth' },
                            envelope: { attack: 0.2, decay: 0.1, sustain: 0.8, release: 1.5 }
                        }).toDestination();
                    });
                }

                registerSynth(name, factory) {
                    this.instruments.set(name, {
                        type: 'synth',
                        factory: factory
                    });
                }

                async createInstrument(name) {
                    const config = this.instruments.get(name);
                    if (!config) {
                        throw new Error(`Unknown instrument: ${name}`);
                    }

                    if (config.type === 'synth') {
                        return config.factory();
                    }

                    throw new Error(`Instrument type not supported: ${config.type}`);
                }
            }

            // ===== InstrumentPool Class =====
            class InstrumentPool {
                constructor(instrumentName, registry, poolSize = 8) {
                    this.instrumentName = instrumentName;
                    this.registry = registry;
                    this.poolSize = poolSize;
                    this.instruments = [];
                    this.nextIndex = 0;
                    this.initialized = false;
                }

                async initialize() {
                    if (this.initialized) return;

                    console.log(`Initializing pool for ${this.instrumentName} with ${this.poolSize} instances`);

                    for (let i = 0; i < this.poolSize; i++) {
                        const instrument = await this.registry.createInstrument(this.instrumentName);
                        this.instruments.push(instrument);
                    }

                    this.initialized = true;
                }

                getNextInstrument() {
                    if (!this.initialized) {
                        throw new Error('Pool not initialized. Call initialize() first.');
                    }

                    const instrument = this.instruments[this.nextIndex];
                    this.nextIndex = (this.nextIndex + 1) % this.instruments.length;
                    return instrument;
                }

                dispose() {
                    this.instruments.forEach(inst => inst.dispose());
                    this.instruments = [];
                    this.initialized = false;
                }
            }

            // ===== Music Playback Function =====
            const instrumentRegistry = new InstrumentRegistry();
            const pools = new Map();

            async function initializeInstruments(trackConfigs) {
                for (const [trackId, instrumentName] of Object.entries(trackConfigs)) {
                    if (!pools.has(trackId)) {
                        const pool = new InstrumentPool(instrumentName, instrumentRegistry, 8);
                        await pool.initialize();
                        pools.set(trackId, pool);
                        console.log(`Initialized pool for track ${trackId}`);
                    }
                }
            }

            async function playMusic() {
                console.log("Initializing music playback...");

                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    console.log("Tone.js audio context started");
                }

                Tone.Transport.cancel();
                console.log("Cleared existing transport events");

                const trackConfigs = {};
                Tone.Transport.bpm.value = 120;
                trackConfigs["melody"] = "synth_lead";

                await initializeInstruments(trackConfigs);

                Tone.Transport.schedule((time) => {
                    const instrument = pools.get("melody").getNextInstrument();
                    instrument.triggerAttackRelease("C4", 0.5, time, 0.8);
                    console.log("Playing C4 on melody");
                }, "0");
                Tone.Transport.schedule((time) => {
                    const instrument = pools.get("melody").getNextInstrument();
                    instrument.triggerAttackRelease("E4", 0.5, time, 0.8);
                    console.log("Playing E4 on melody");
                }, "0.5");
                Tone.Transport.schedule((time) => {
                    const instrument = pools.get("melody").getNextInstrument();
                    instrument.triggerAttackRelease("G4", 0.5, time, 0.8);
                    console.log("Playing G4 on melody");
                }, "1");

                Tone.Transport.start();
                console.log("Music playback started");

                setTimeout(() => {
                    Tone.Transport.stop();
                    console.log("Music playback finished");
                }, 8000);
            }

            playMusic().catch(console.error);
        });
    </script>
</body>
</html>